<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ title if title else "My Finance Site" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<nav>
    <a href="{{ url_for('home') }}">ğŸ  Home</a>
    <a href="{{ url_for('home') }}">ğŸ“° Latest News</a>

    <!-- Dropdown starts -->
    <div class="dropdown">
        <span class="dropbtn">ğŸ“Š Analysis â–¾</span>
        <div class="dropdown-content">
            <a href="{{ url_for('stock_analysis') }}">Stock Analysis</a>
            <a href="{{ url_for('time_series') }}">Time Series Analysis</a>
            <a href="{{ url_for('market_prediction') }}">Regression Fit</a>
            <!-- Link example -->
            <a href="https://lstmt.onrender.com/" target="_blank" rel="noopener noreferrer">LSMT Forecast (Trial)</a>
        </div>
    </div>
    <!-- Dropdown ends -->

    <a href="{{ url_for('math_area') }}">â— Math Area</a>

    <!-- â³ Clock on the right -->
    <span id="clock" class="nav-clock"></span>

    <!-- Visitor Counter -->
    <div class="counter-container">
        Visitors: <span id="visitorCounter" class="counter">1000</span>
    </div>
</nav>

<!-- Scrolling Ticker -->
<div class="ticker-wrapper">
    <div class="ticker" id="ticker">Loading stock data...</div>
</div>

<!-- Main layout with sidebars -->
<main>
    {% if sidebar is defined and sidebar %}
        <!-- Left Sidebar -->
        <aside class="sidebar left">
            <h3>ğŸ“ˆ Market Snapshot</h3>
            {% for k,v in sidebar['market_snapshot'].items() %}
                <p>{{ k }}: {{ v }}</p>
            {% endfor %}
            <hr>
            <h3>ğŸ”” Alerts</h3>
            <ul>
                {% for a in sidebar['alerts'] %}
                    <li>{{ a }}</li>
                {% endfor %}
            </ul>
        </aside>
    {% endif %}

    <!-- Central Content -->
    <section class="content-area">
        {% block content %}{% endblock %}
    </section>

    {% if sidebar is defined and sidebar %}
        <!-- Right Sidebar -->
        <aside class="sidebar right">
            <h3>ğŸ“° Quick Updates <span class="blink-new">NEW</span></h3>
            <ul>
                {% for u in sidebar['quick_updates'] %}
                    <li>{{ u }}</li>
                {% endfor %}
            </ul>
            <hr>
            <h3>ğŸ’¡ Analysis Tip</h3>
            <p>{{ sidebar['analysis_tip'] }}</p>
        </aside>
    {% endif %}
</main>

<!-- Clock + Counter -->
<script>
function updateClock() {
    const now = new Date();
    const hr   = String(now.getHours()).padStart(2, '0');
    const min  = String(now.getMinutes()).padStart(2, '0');
    const sec  = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('clock').textContent = `${hr}:${min}:${sec}`;
}
setInterval(updateClock, 1000);
updateClock();

function animateCounter(element, newValue) {
    let current = parseInt(element.textContent);
    const stepTime = 50, steps = 20;
    const increment = (newValue - current) / steps;
    let step = 0;
    const timer = setInterval(() => {
        step++;
        current += increment;
        element.textContent = Math.floor(current);
        if(step >= steps){
            element.textContent = newValue;
            clearInterval(timer);
        }
    }, stepTime);
}
const visitorElement = document.getElementById('visitorCounter');
setInterval(() => {
    let current = parseInt(visitorElement.textContent);
    animateCounter(visitorElement, current + 1);
}, 15 * 60 * 1000);
</script>

<!-- ğŸ“Š Market Snapshot Auto-refresh -->
<script>
function updateMarketSnapshot() {
    fetch("/api/market_snapshot")
        .then(res => res.json())
        .then(data => {
            const container = document.querySelector(".sidebar.left");
            if (!container) return;

            // Clear old content first
            let html = "<h3>ğŸ“ˆ Market Snapshot</h3>";
            for (let key in data) {
                let value = data[key];
                let arrowMatch = value.match(/[â–²â–¼]/);
                if (arrowMatch) {
                    let color = arrowMatch[0] === "â–²" ? "green" : "red";
                    value = value.replace(
                        arrowMatch[0],
                        `<span style="color:${color}; font-weight:bold;">${arrowMatch[0]}</span>`
                    );
                }
                html += `<p>${key}: ${value}</p>`;
            }

            // ğŸ”‘ overwrite only the snapshot section
            container.innerHTML = html + "<hr>" + container.innerHTML.split("<hr>")[1];
        })
        .catch(err => {
            console.error("Snapshot fetch error:", err);
        });
}

setInterval(updateMarketSnapshot, 30000);
updateMarketSnapshot();
</script>


<!-- ğŸ”„ Ticker Auto-refresh -->
<script>
const tickerDiv = document.getElementById("ticker");
let tickerParts = [];

async function fetchTickerData() {
    try {
        const res = await fetch("/api/nifty_ticker");
        const stocks = await res.json();

        if (!stocks || stocks.length === 0) {
            // No new data, keep last values (do not overwrite)
            return;
        }

        // Use stocks with price > 0 if available, else fallback to all stocks
        const validStocks = stocks.filter(stock => typeof stock.price === "number" && stock.price > 0);
        const displayStocks = validStocks.length > 0 ? validStocks : stocks;

        tickerParts = displayStocks.map(stock => {
            let price = (stock.price && stock.price > 0) ? stock.price.toFixed(2) : "â€“";
            let change = (typeof stock.change === "number" && !isNaN(stock.change)) ? stock.change.toFixed(2) : "â€“";
            let arrow = stock.arrow || "";
            let color = stock.color || "white";
            return `${stock.symbol}: ${price} <span style="color:${color}">${arrow}${change}</span>`;
        });

        tickerDiv.innerHTML = tickerParts.join("  |  ") + "  |  " + tickerParts.join("  |  ");
    } catch (err) {
        console.error("Ticker fetch error:", err);
        // Keep last values, do not overwrite
    }
}

fetchTickerData();
setInterval(fetchTickerData, 30000);
</script>

<footer style="text-align:center; padding:15px; background:#f2f2f2; margin-top:30px; font-size:0.9rem; color:#555;">
    &copy; {{ current_year if current_year else "2025" }} Myequitytime. All Rights Reserved.
</footer>
</body>
</html>

